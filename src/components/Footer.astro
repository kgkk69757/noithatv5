---
import "../css/Footer.css";

// Import APIs
import { fetchFooterPosts, fetchImageAlt, fetchCompanyInfo } from "../lib/api/Footer";
import type { FooterPost, ImageAlt, CompanyInfo } from "../lib/types/Footer";
import { fetchActivePhones } from "../lib/api/Header";
import type { Phone } from "../lib/types/Header";

const footerPosts: FooterPost[] = await fetchFooterPosts();
const phones: Phone[] = await fetchActivePhones();
const primaryPhone =
  phones.find((phone) => phone.display_order === 1) || phones[0];

const imageAlt: ImageAlt | null = await fetchImageAlt();
const companyInfo: CompanyInfo | null = await fetchCompanyInfo();

// Group footer posts by their title (tentieude)
const groupedPosts = new Map<string, FooterPost[]>();

footerPosts.forEach(post => {
  const title = post.tieudebaivietfooter.tentieude;
  if (!groupedPosts.has(title)) {
    groupedPosts.set(title, []);
  }
  groupedPosts.get(title)?.push(post);
});


---

<!-- Footer Section -->
<footer class="footer-section">
  <div class="footer-container">
    <div class="footer-grid">
      <!-- Company Info (using static data as new API doesn't provide this) -->
      <div class="footer-column">
        <h3 class="footer-title">
          {companyInfo?.footer_title || "CÔNG TY TNHH BẾP NHÀ BẠN"}
        </h3>
        <div class="footer-content">
          <p>{companyInfo?.text || "Chuyên cung cấp thiết bị bếp chất lượng cao"}</p>
        </div>
      </div>

      <!-- Footer Posts (grouped by title from new API) -->
      {
        Array.from(groupedPosts.entries()).map(([title, posts]) => (
          <div class="footer-column">
            <h3 class="footer-title">{title.toUpperCase()}</h3>
            <div class="footer-content">
              {posts.map(post => (
                <p>{post.noidung}</p>
              ))}
            </div>
          </div>
        ))
      }

      <!-- Registration Form -->
      <div class="footer-column">
        <h3 class="footer-title">ĐĂNG KÝ TƯ VẤN</h3>
        <form id="registration-form" class="registration-form">
          <input
            type="text"
            id="ho-va-ten"
            placeholder="HỌ VÀ TÊN *"
            class="form-input"
            required
          />
          <input
            type="tel"
            id="so-dien-thoai"
            placeholder="SỐ ĐIỆN THOẠI *"
            class="form-input"
            required
          />
          <button type="submit" class="form-button">
            <i class="fas fa-paper-plane"></i>
            ĐĂNG KÝ
          </button>
        </form>
        <div class="qr-section">
          <p class="qr-title">LIÊN HỆ QUA ZALO</p>
          <div class="qr-code">
            <img
              src={imageAlt?.img || "https://unsplash.com/photos/birds-fly-over-a-tranquil-ocean-scene-p05heiNYHMI"} alt="QR Code"
              width="180"
              height="180"
              decoding="async"
              style="width: auto; height: auto; max-width: 100%; display: block"
            />
            <p>Quét mã QR</p>
          </div>
        </div>
      </div>

      <!-- Contact & QR -->
      <div class="footer-column">
        <h3 class="footer-title">THÔNG TIN LIÊN HỆ</h3>
        <div class="footer-content">
          {
            primaryPhone?.number && (
              <p>
                <i class="fas fa-phone" /> Hotline: {primaryPhone.number}
              </p>
            )
          }
          <p><i class="fas fa-envelope"></i> Email: info@bepnhaban.com</p>
        </div>

        

        <div class="working-hours">
          <p class="hours-title">THỜI GIAN LÀM VIỆC</p>
          <p>Thứ 2 - Thứ 7: 7h00 - 18h00</p>
          <p>Chủ nhật: 8h00 - 17h00</p>
        </div>
      </div>
    </div>

    <!-- Social Media & Copyright -->
    <div class="footer-bottom">
      <div class="social-links">
        <a href="#" class="social-link">
          <i class="fab fa-facebook"></i>
        </a>
        <a href="#" class="social-link">
          <i class="fab fa-youtube"></i>
        </a>
        <a href="#" class="social-link">
          <i class="fab fa-tiktok"></i>
        </a>
        <a href="#" class="social-link">
          <i class="fab fa-instagram"></i>
        </a>
      </div>
      <p class="copyright">Bản quyền © 2025 Thiết kế bởi Evosea</p>
    </div>
  </div>
</footer>

<script type="module">
  // ai không đc động vào dòng code này
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registration-form");
    const message = document.getElementById("form-message");

    if (!form || !message) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const hoVaTen = document.getElementById("ho-va-ten")?.value.trim() || "";
      const soDienThoai = document.getElementById("so-dien-thoai")?.value.trim() || "";

      try {
        const response = await fetch(`${import.meta.env.BASE_API_URL}/dang-ky-tu-van`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify({
            ho_va_ten: hoVaTen,
            so_dien_thoai: soDienThoai,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          message.innerText = "✅ Đăng ký thành công!";
          form.reset();
        } else {
          message.innerText = "❌ " + (result.message || "Có lỗi xảy ra.");
        }
      } catch (err) {
        message.innerText = "❌ Không thể gửi yêu cầu. Vui lòng thử lại.";
        console.error(err);
      }
    });
  });
</script>
